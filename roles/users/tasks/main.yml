- name: Set target user fact
  set_fact:
    target: "{{ target_user }}"   # now no default is provided

- name: Generate a temporary random password for {{ target }}
  set_fact:
    red_tmp_pass: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"

- name: Hash that password with SHA-512 (requires openssl on your control node)
  set_fact:
    red_pass_hash: "{{ lookup('pipe', 'openssl passwd -6 ' + red_tmp_pass) }}"

- name: Create or update user {{ target }} (with hashed password so we can unlock)
  user:
    name: "{{ target }}"
    comment: "User {{ target }} with home on SSD"
    home: "/home/{{ target }}"
    shell: /usr/bin/zsh
    groups: sudo
    state: present
    create_home: yes

    password: "{{ red_pass_hash }}"
    update_password: on_create

    password_lock: false

- name: Ensure .ssh directory exists for user {{ target }}
  file:
    path: "/home/{{ target }}/.ssh"
    state: directory
    owner: "{{ target }}"
    group: "{{ target }}"
    mode: '0700'

- name: Install SSH key files for user {{ target }}
  vars:
    ssh_keys:
      - { key_var: "public_key_file",  dest: "/home/{{ target }}/.ssh/authorized_keys",                     mode: "0600" }
      - { key_var: "private_key_file", dest: "/home/{{ target }}/.ssh/{{ target }}_{{ ssh_key_suffix | default('id_rsa') }}", mode: "0600" }
  loop: "{{ ssh_keys }}"
  copy:
    src: "{{ lookup('vars', item.key_var) }}"
    dest: "{{ item.dest }}"
    owner: "{{ target }}"
    group: "{{ target }}"
    mode: "{{ item.mode }}"
  when: lookup('vars', item.key_var, default='') != ''
