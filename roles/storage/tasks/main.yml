---
# roles/storage/tasks/main.yml

- name: Install parted
  apt:
    name: parted
    state: present
    update_cache: yes
  become: yes

- name: Unmount /home if it’s mounted
  mount:
    path: /home
    state: absent
  become: yes

- name: Turn off any swap on /dev/sda1 (ignore errors)
  shell: swapoff /dev/sda1 || true
  args:
    executable: /bin/bash
  become: yes

- name: Ensure a single GPT partition on /dev/sda (1MiB → 100% ext4)
  parted:
    device: /dev/sda
    label: gpt                 # ← makes sure the table is GPT
    number: 1
    state: present
    part_start: 1MiB
    part_end: 100%
    fs_type: ext4
  register: parted_res
  become: yes

- name: Wipe stray filesystems on /dev/sda1 (only if we just re-partitioned)
  command: wipefs -a /dev/sda1
  when: parted_res.changed
  become: yes

- name: Format /dev/sda1 as ext4
  filesystem:
    fstype: ext4
    dev: /dev/sda1
  become: yes

- name: Ensure /home directory exists
  file:
    path: /home
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Mount /dev/sda1 on /home and add to fstab
  mount:
    path: /home
    src: /dev/sda1
    fstype: ext4
    opts: defaults
    state: mounted
  become: yes
