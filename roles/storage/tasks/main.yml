---
# roles/storage/tasks/main.yml

- name: Install parted
  apt:
    name: parted
    state: present
    update_cache: yes
  become: yes

- name: Unmount /home and remove fstab entry
  mount:
    path: /home
    state: absent
  become: yes

- name: Turn off any swap on /dev/sda*
  shell: |
    for p in /dev/sda*; do
      swapoff "$p" || true
    done
  args:
    executable: /bin/bash
  become: yes

- name: Wipe partition table on /dev/sda
  command: parted /dev/sda --script mklabel gpt
  become: yes

- name: Create a single GPT partition on /dev/sda
  parted:
    device: /dev/sda
    number: 1
    state: present
    part_start: 1MiB
    part_end: 100%
    fs_type: ext4
  become: yes

- name: Wipe existing filesystem signatures on /dev/sda1
  command: wipefs -a /dev/sda1
  become: yes

- name: Format /dev/sda1 as ext4
  filesystem:
    fstype: ext4
    dev: /dev/sda1
  become: yes

- name: Ensure /home directory exists
  file:
    path: /home
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Mount /dev/sda1 on /home and add to fstab
  mount:
    path: /home
    src: /dev/sda1
    fstype: ext4
    opts: defaults
    state: mounted
  become: yes
