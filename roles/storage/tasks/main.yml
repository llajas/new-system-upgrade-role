---
# roles/storage/tasks/main.yml

- name: Install parted
  apt:
    name: parted
    state: present
    update_cache: yes
  become: yes

- name: Get current partition table info for /dev/sda
  command: parted /dev/sda print
  become: yes
  register: parted_info
  changed_when: false
  failed_when: false

- name: Check if /dev/sda1 is mounted
  command: mount | grep '/dev/sda1'
  become: yes
  register: sda1_mount
  changed_when: false
  failed_when: false

- name: Wipe partition table on /dev/sda if not already gpt, no partition 1 exists, and no partition is mounted
  command: parted /dev/sda --script mklabel gpt
  become: yes
  when: >
    ("gpt" not in parted_info.stdout.lower()) and 
    (sda1_mount.stdout == "") and 
    (not (parted_info.stdout | regex_search('(?m)^\\s*1\\s')))
  # The regex looks for a line that starts with the partition number "1"

- name: Create a single GPT partition on /dev/sda
  parted:
    device: /dev/sda
    number: 1
    state: present
    part_start: 1MiB
    part_end: 100%
    fs_type: ext4
  become: yes

- name: Turn off any swap on /dev/sda1
  command: swapoff /dev/sda1
  ignore_errors: yes
  become: yes

- name: Wipe existing filesystem signatures on /dev/sda1
  command: wipefs -a /dev/sda1
  become: yes

- name: Format the partition as ext4
  filesystem:
    fstype: ext4
    dev: /dev/sda1
  become: yes

- name: Ensure /home exists
  file:
    path: /home
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Mount /dev/sda1 on /home and add to fstab
  mount:
    path: /home
    src: /dev/sda1
    fstype: ext4
    opts: defaults
    state: mounted
  become: yes
