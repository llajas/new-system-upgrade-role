---
# 1) Import the GPG keys we’ll need for the archive
- name: Import missing GPG keys for Debian repositories
  raw: |
    apt-key adv --keyserver keyserver.ubuntu.com \
      --recv-keys 0E98404D386FA1D9 6ED0E7B82643E131
  changed_when: false

# 2) Wipe out any old sources lists
- name: Remove all old apt source lists
  raw: rm -f /etc/apt/sources.list /etc/apt/sources.list.d/*.list
  changed_when: false

# 3) Point at the archived Stretch + backports repos
- name: Configure Apt for archived Stretch & backports
  raw: |
    cat > /etc/apt/apt.conf.d/99stretch-archive << 'EOF'
    Acquire {
      Check-Valid-Until "false";
      AllowInsecureRepositories "true";
      PDiffs "false";
    };
    EOF

    cat > /etc/apt/sources.list << 'EOF'
    # Debian 9 (Stretch) main archive
    deb http://archive.debian.org/debian           stretch           main contrib non-free
    # Stretch security
    deb http://archive.debian.org/debian-security  stretch/updates   main contrib non-free
    # Stretch updates
    deb http://archive.debian.org/debian           stretch-updates   main contrib non-free
    # Backports for Stretch (contains Python 3.7)
    deb http://archive.debian.org/debian           stretch-backports main contrib non-free
    EOF
  changed_when: false

# 4) Refresh the cache so backports show up
- name: Update apt cache (for Stretch + backports)
  raw: |
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -o Acquire::Check-Valid-Until=false
  changed_when: false

# 5) Raw-install Python 3.7 + keyring from backports
- name: Install Python 3.7, venv, python3-apt & keyring (raw)
  raw: |
    export DEBIAN_FRONTEND=noninteractive
    apt-get install -y --allow-unauthenticated \
      --no-install-recommends \
      -o Dpkg::Options::="--force-confdef" \
      -o Dpkg::Options::="--force-confold" \
      -t stretch-backports \
      python3.7 python3.7-venv python3.7-apt debian-archive-keyring
  changed_when: false

- name: Give the new python time to settle
  pause:
    seconds: 5

# 6) Point Ansible at Python 3.7
- name: Set ansible_python_interpreter to python3.7
  set_fact:
    ansible_python_interpreter: /usr/bin/python3.7

# 7) Now we can safely use the normal apt: module under Python 3.7
- name: Install OpenSSH server
  apt:
    name: openssh-server
    state: present
    update_cache: yes
    install_recommends: no

# 8) Generate an ED25519 keypair on the CONTROL node, once
- name: Ensure we have a root ed25519 keypair (control machine)
  delegate_to: localhost
  local_action:
    module: command
    cmd: ssh-keygen -t ed25519 -f "{{ playbook_dir }}/files/root_id_ed25519" -N ''
    creates: "{{ playbook_dir }}/files/root_id_ed25519"

# 9) Deploy the public key into root’s authorized_keys
- name: Ensure /root/.ssh exists
  file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Install root’s ed25519 public key
  authorized_key:
    user: root
    key: "{{ lookup('file', playbook_dir ~ '/files/root_id_ed25519.pub') }}"
    state: present
