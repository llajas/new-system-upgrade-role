---
# 0) Read the local OS version out of /etc/os-release
- name: Get VERSION_ID from /etc/os-release by sourcing the file
  raw: ". /etc/os-release && echo $VERSION_ID"
  register: current_release_raw
  changed_when: false

- name: Set current_release from raw stdout
  set_fact:
    current_release: "{{ current_release_raw.stdout }}"

- name: Print current_release
  debug:
    msg: "Current release is {{ current_release }}"
# ─────────────────────────────────────────────────────────────
# Phase 1: Jessie (8) → Stretch (9)
# ─────────────────────────────────────────────────────────────
- block:
    - name: Configure APT for Stretch upgrade
      raw: |
        cat > /etc/apt/apt.conf.d/99stretch-archive << 'EOF'
        Acquire {
          Check-Valid-Until "false";
          AllowInsecureRepositories "true";
        };
        EOF

        cat > /etc/apt/sources.list << 'EOF'
        deb http://archive.debian.org/debian           stretch        main contrib non-free
        deb http://archive.debian.org/debian-security  stretch/updates main contrib non-free
        deb http://archive.debian.org/debian           stretch-updates main
        EOF
      changed_when: false

    - name: Dist-upgrade Jessie → Stretch
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get dist-upgrade -y \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold"
      changed_when: false

    - name: Reboot into Stretch
      raw: |
        reboot now
      ignore_unreachable: true

    - name: Wait for SSH port to be open (run on control node)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Wait for shell to actually accept commands
      raw: uptime
      register: upcheck
      until: upcheck.rc == 0
      retries: 30
      delay: 10
  when: current_release | int == 8

# ─────────────────────────────────────────────────────────────
# Phase 2: Stretch (9) → Buster (10)
# ─────────────────────────────────────────────────────────────
- block:
    - name: Configure APT for Buster upgrade
      raw: |
        cat > /etc/apt/sources.list << 'EOF'
        deb http://archive.debian.org/debian           buster         main contrib non-free
        deb http://archive.debian.org/debian-security  buster/updates main contrib non-free
        deb http://archive.debian.org/debian           buster-updates main
        EOF
      changed_when: false

    - name: Dist-upgrade Stretch → Buster
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get dist-upgrade -y \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold"
      changed_when: false

    - name: Reboot into Buster
      raw: |
        reboot now
      ignore_unreachable: true

    - name: Wait for SSH port to be open (run on control node)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Wait for shell to actually accept commands
      raw: uptime
      register: upcheck
      until: upcheck.rc == 0
      retries: 30
      delay: 10
  when: current_release | int == 9

# ─────────────────────────────────────────────────────────────
# Phase 3: Buster (10) → Bullseye (11)
# ─────────────────────────────────────────────────────────────
- block:

    - name: Configure APT for Bullseye upgrade
      raw: |
        cat > /etc/apt/sources.list << 'EOF'
        deb http://deb.debian.org/debian               bullseye        main contrib non-free
        deb http://security.debian.org/debian-security bullseye-security main contrib non-free
        deb http://deb.debian.org/debian               bullseye-updates main
        EOF
      changed_when: false

    - name: Dist-upgrade Buster → Bullseye
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get dist-upgrade -y \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold"
      changed_when: false

    - name: Reboot into Bullseye
      raw: |
        reboot now
      ignore_unreachable: true

    - name: Wait for SSH port to be open (run on control node)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Wait for shell to actually accept commands
      raw: uptime
      register: upcheck
      until: upcheck.rc == 0
      retries: 30
      delay: 10
  when: current_release | int == 10

# ─────────────────────────────────────────────────────────────
# Phase 4: Bullseye (11) → Bookworm (12)
# ─────────────────────────────────────────────────────────────
- block:
    - name: Install Python 3.9 venv, python3-apt & OpenSSH (raw)
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get install -y --allow-unauthenticated \
          --no-install-recommends \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold" \
          python3.9 \
          python3.9-distutils \
          python3.9-venv \
          python3-apt \
          openssh-server \
          debian-archive-keyring
      changed_when: false

    - name: Pause for Python 3.9 to settle
      pause:
        seconds: 5

    - name: Point Ansible at Python 3.9
      set_fact:
        ansible_python_interpreter: /usr/bin/python3.9
    
    - name: Re-gather facts now that Python is available
      meta: reset_connection

    - name: Gather real facts
      setup: {}

    - name: Reboot
      reboot:
        msg: "Rebooting after upgrade to Bullseye"
        reboot_timeout: 300
        test_command: uptime
      ignore_unreachable: true

    - name: Configure APT for Bookworm upgrade
      copy:
        dest: /etc/apt/sources.list
        content: |
          deb http://deb.debian.org/debian               bookworm        main contrib non-free
          deb http://security.debian.org/debian-security bookworm-security main contrib non-free
          deb http://deb.debian.org/debian               bookworm-updates main
      notify: Update apt cache

    - name: Upgrade Bullseye → Bookworm
      apt:
        update_cache: yes
        upgrade: dist

    - name: Reboot into Bookworm
      reboot:
        msg: "Rebooting after upgrade to Bookworm"
        reboot_timeout: 300
        test_command: uptime
  when: current_release | int == 11