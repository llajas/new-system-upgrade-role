---
- name: Import missing GPG keys for Debian repositories (raw)
  raw: |
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0E98404D386FA1D9 6ED0E7B82643E131
  changed_when: false

- name: Wipe out all old .list files
  raw: rm -f /etc/apt/sources.list /etc/apt/sources.list.d/*.list

- name: Configure Apt to use only the Jessie archive
  raw: |
    cat > /etc/apt/apt.conf.d/99jessie-archive <<'EOF'
    Acquire {
      Check-Valid-Until "false";
      AllowInsecureRepositories "true";
      PDiffs "false";
    };
    EOF

    cat > /etc/apt/sources.list <<'EOF'
    deb http://archive.debian.org/debian           jessie        main contrib non-free
    deb http://archive.debian.org/debian-security  jessie/updates main contrib non-free
    EOF
  changed_when: false

- name: Prime the keyring and install a minimal Python
  raw: |
    apt-get update \
      -o Acquire::Check-Valid-Until=false \
      -o Acquire::PDiffs=false \
      && apt-get install -y --no-install-recommends \
         -o APT::Default-Release=jessie \
         debian-archive-keyring python3-minimal
  changed_when: false

- name: Pause for 10 seconds to allow python3 installation to settle
  pause:
    seconds: 10

- name: Locate the installed python3 interpreter
  raw: which python3 || true
  register: python3_location
  changed_when: false

- name: Set the Python interpreter for future tasks if found
  set_fact:
    ansible_python_interpreter: "{{ python3_location.stdout | trim }}"
  when: python3_location.stdout | trim != ""

- name: Fail if no python3 interpreter was found
  fail:
    msg: "python3 was not found after installation"
  when: python3_location.stdout | trim == ""

- name: Install full python3 and openssh-server (APT pinned to Jessie)
  apt:
    name:
      - python3
      - openssh-server
    state: present
    update_cache: yes
    install_recommends: no
    default_release: jessie

- name: Generate root ed25519 keypair if not already present
  command: ssh-keygen -t ed25519 -f "{{ playbook_dir }}/../playbooks/files/root_id_ed25519" -N ''
  args:
    creates: "{{ playbook_dir }}/../playbooks/files/root_id_ed25519"