---
# 0) Read the local OS version out of /etc/os-release
- name: Get VERSION_ID from /etc/os-release by sourcing the file
  raw: ". /etc/os-release && echo $VERSION_ID"
  register: current_release_raw
  changed_when: false

- name: Set current_release from raw stdout
  set_fact:
    current_release: "{{ current_release_raw.stdout | trim }}"

- name: Print current_release
  debug:
    msg: "Current release is {{ current_release }}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Phase 1: Jessie (8) â†’ Stretch (9)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- block:
    - name: Purge any extra APT sources (only want Stretch archives)
      raw: >
        rm -f /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources 2>/dev/null || true
      changed_when: false

    - name: Configure APT for Stretch upgrade
      raw: >
        printf '%s\n' \
        'APT::Get::AllowUnauthenticated "true";' \
        'Acquire {' \
        '  Check-Valid-Until "false";' \
        '  AllowInsecureRepositories "true";' \
        '};' \
        > /etc/apt/apt.conf.d/99stretch-archive;
        printf '%s\n' \
        'deb http://archive.debian.org/debian stretch main contrib non-free' \
        'deb http://archive.debian.org/debian-security stretch/updates main contrib non-free' \
        > /etc/apt/sources.list
      changed_when: false

    - name: Dist-upgrade Jessie â†’ Stretch
      raw: >
        export DEBIAN_FRONTEND=noninteractive;
        apt-get clean;
        rm -rf /var/lib/apt/lists/*;
        apt-get update -o Acquire::Check-Valid-Until=false;
        apt-get dist-upgrade -y --force-yes
        -o Dpkg::Options::="--force-confdef"
        -o Dpkg::Options::="--force-confold"
      changed_when: false

    - name: Reboot into Stretch
      raw: reboot now
      ignore_unreachable: true

    - name: Wait for SSH port to be open (run on control node)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Wait for shell to actually accept commands
      raw: uptime
      register: upcheck
      until: upcheck.rc == 0
      retries: 30
      delay: 10

    # ðŸ” Refresh VERSION_ID so later phases see 9 instead of 8
    - name: Refresh current_release after Stretch reboot
      raw: ". /etc/os-release && echo $VERSION_ID"
      register: current_release_raw
      changed_when: false

    - name: Update current_release fact (now on Stretch)
      set_fact:
        current_release: "{{ current_release_raw.stdout | trim }}"

    - debug:
        msg: "After Stretch reboot, current_release is {{ current_release }}"
  when: current_release | int == 8

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Phase 2: Stretch (9) â†’ Buster (10)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- block:
    - name: Configure APT for Buster upgrade
      raw: |
        cat > /etc/apt/sources.list << 'EOF'
        deb http://archive.debian.org/debian           buster         main contrib non-free
        deb http://archive.debian.org/debian-security  buster/updates main contrib non-free
        deb http://archive.debian.org/debian           buster-updates main
        EOF
      changed_when: false

    - name: Dist-upgrade Stretch â†’ Buster
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get dist-upgrade -y \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold"
      changed_when: false

    - name: Reboot into Buster
      raw: reboot now
      ignore_unreachable: true

    - name: Wait for SSH port to be open (run on control node)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Wait for shell to actually accept commands
      raw: uptime
      register: upcheck
      until: upcheck.rc == 0
      retries: 30
      delay: 10

    # ðŸ” Refresh VERSION_ID so later phases see 10
    - name: Refresh current_release after Buster reboot
      raw: ". /etc/os-release && echo $VERSION_ID"
      register: current_release_raw
      changed_when: false

    - name: Update current_release fact (now on Buster)
      set_fact:
        current_release: "{{ current_release_raw.stdout | trim }}"
    - debug:
        msg: "After Buster reboot, current_release is {{ current_release }}"
  when: current_release | int == 9

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Phase 3: Buster (10) â†’ Bullseye (11)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- block:
    - name: Configure APT for Bullseye upgrade
      raw: |
        cat > /etc/apt/sources.list << 'EOF'
        deb http://deb.debian.org/debian               bullseye        main contrib non-free
        deb http://security.debian.org/debian-security bullseye-security main contrib non-free
        deb http://deb.debian.org/debian               bullseye-updates main
        EOF
      changed_when: false

    - name: Dist-upgrade Buster â†’ Bullseye
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get dist-upgrade -y \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold"
      changed_when: false

    - name: Reboot into Bullseye
      raw: reboot now
      ignore_unreachable: true

    - name: Wait for SSH port to be open (run on control node)
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 10
        timeout: 300
      delegate_to: localhost
      become: false

    - name: Wait for shell to actually accept commands
      raw: uptime
      register: upcheck
      until: upcheck.rc == 0
      retries: 30
      delay: 10

    # ðŸ” Refresh VERSION_ID so Phase 4 sees 11
    - name: Refresh current_release after Bullseye reboot
      raw: ". /etc/os-release && echo $VERSION_ID"
      register: current_release_raw
      changed_when: false

    - name: Update current_release fact (now on Bullseye)
      set_fact:
        current_release: "{{ current_release_raw.stdout | trim }}"
    - debug:
        msg: "After Bullseye reboot, current_release is {{ current_release }}"
  when: current_release | int == 10

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Phase 4: Bullseye (11) â†’ Bookworm (12)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- block:
    - name: Install Python 3 venv, python3-apt & OpenSSH (raw)
      raw: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -o Acquire::Check-Valid-Until=false
        apt-get install -y --allow-unauthenticated \
          --no-install-recommends \
          -o Dpkg::Options::="--force-confdef" \
          -o Dpkg::Options::="--force-confold" \
          python3 \
          python3-distutils \
          python3-venv \
          python3-apt \
          openssh-server \
          debian-archive-keyring
      changed_when: false

    - name: Pause for Python 3.9 to settle
      pause:
        seconds: 5

    - name: Point Ansible at Python 3.9
      set_fact:
        ansible_python_interpreter: /usr/bin/python3.9

    - name: Re-gather facts now that Python is available
      meta: reset_connection

    - name: Gather real facts
      setup: {}

    - name: Reboot after Python install / Bullseye upgrades
      reboot:
        msg: "Rebooting after upgrade to Bullseye + Python install"
        reboot_timeout: 300
        test_command: uptime
      ignore_unreachable: true

    - name: Configure APT for Bookworm upgrade
      copy:
        dest: /etc/apt/sources.list
        content: |
          deb http://deb.debian.org/debian               bookworm           main contrib non-free non-free-firmware
          deb http://security.debian.org/debian-security bookworm-security  main contrib non-free non-free-firmware
          deb http://deb.debian.org/debian               bookworm-updates   main contrib non-free non-free-firmware

    - name: Point Ansible at system python3 (not version-pinned)
      set_fact:
        ansible_python_interpreter: /usr/bin/python3

    - name: Upgrade Bullseye â†’ Bookworm
      apt:
        update_cache: yes
        upgrade: dist

    - name: Reboot into Bookworm
      reboot:
        msg: "Rebooting after upgrade to Bookworm"
        reboot_timeout: 300
        test_command: uptime
      ignore_unreachable: true

    # ðŸ” Refresh VERSION_ID so Phase 5 sees 12
    - name: Refresh current_release after Bookworm reboot
      raw: ". /etc/os-release && echo $VERSION_ID"
      register: current_release_raw
      changed_when: false

    - name: Update current_release fact (now on Bookworm)
      set_fact:
        current_release: "{{ current_release_raw.stdout | trim }}"
    - debug:
        msg: "After Bookworm reboot, current_release is {{ current_release }}"
  when: current_release | int == 11

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Phase 5: Bookworm (12) â†’ Trixie (13)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- block:
    - name: Configure APT for Trixie (deb822)
      copy:
        dest: /etc/apt/sources.list.d/debian.sources
        content: |
          Types: deb
          URIs: https://deb.debian.org/debian
          Suites: trixie trixie-updates
          Components: main contrib non-free non-free-firmware
          Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

          Types: deb
          URIs: https://security.debian.org/debian-security
          Suites: trixie-security
          Components: main contrib non-free non-free-firmware
          Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

    - name: Full upgrade Bookworm â†’ Trixie
      apt:
        update_cache: yes
        upgrade: dist

    - name: Reboot into Trixie
      reboot:
        msg: "Rebooting after upgrade to Trixie"
        reboot_timeout: 600
        test_command: "cat /etc/os-release"
      ignore_unreachable: true

    # refresh VERSION_ID for any subsequent logic
    - name: Refresh current_release (post-Trixie reboot)
      raw: ". /etc/os-release && echo $VERSION_ID"
      register: current_release_raw_post
      changed_when: false

    - set_fact:
        current_release: "{{ current_release_raw_post.stdout | trim }}"

    - debug:
        msg: "After Trixie reboot, current_release is {{ current_release }}"
  when: current_release | int == 12
