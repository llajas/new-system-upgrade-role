---
- name: Import missing GPG keys for Debian repositories (raw)
  raw: |
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0E98404D386FA1D9 6ED0E7B82643E131
  changed_when: false

- name: Configure jessie archive repositories (raw)
  raw: |
    echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99jessie-archive
    echo 'Acquire::AllowInsecureRepositories "true";' >> /etc/apt/apt.conf.d/99jessie-archive
    cat > /etc/apt/sources.list.d/jessie.list <<EOF
deb http://archive.debian.org/debian           jessie       main
deb http://archive.debian.org/debian-updates   jessie       main
deb http://archive.debian.org/debian-security  jessie/updates main
EOF
  changed_when: false

- name: Ensure apt keyring is installed (raw) with Jessie pinning
  raw: |
    apt-get update -o Acquire::Check-Valid-Until=false && apt-get install -y --no-install-recommends -o APT::Default-Release=jessie debian-archive-keyring || true
  changed_when: false

- name: Ensure minimal python3 is installed (raw) with Jessie pinning
  raw: |
    apt-get update -o Acquire::Check-Valid-Until=false && apt-get install -y --no-install-recommends -o APT::Default-Release=jessie python3-minimal || true
  changed_when: false

- name: Pause for 10 seconds to allow python3 installation to settle
  pause:
    seconds: 10

- name: Set the Python interpreter for future tasks
  set_fact:
    ansible_python_interpreter: /usr/bin/python3

- name: Install full python3 and openssh-server (APT pinned to Jessie)
  apt:
    name:
      - python3
      - openssh-server
    state: present
    update_cache: yes
    install_recommends: no
    default_release: jessie

- name: Generate root ed25519 keypair if not already present
  command: ssh-keygen -t ed25519 -f "{{ playbook_dir }}/../playbooks/files/root_id_ed25519" -N ''
  args:
    creates: "{{ playbook_dir }}/../playbooks/files/root_id_ed25519"