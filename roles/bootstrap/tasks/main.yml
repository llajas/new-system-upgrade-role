---
# 1) Import the GPG keys we’ll need for the archive
- name: Import missing GPG keys for Debian repositories (raw)
  raw: |
    apt-key adv --keyserver keyserver.ubuntu.com \
      --recv-keys 0E98404D386FA1D9 6ED0E7B82643E131
  changed_when: false

# 2) Wipe out any old sources lists
- name: Remove all old apt source lists
  raw: rm -f /etc/apt/sources.list /etc/apt/sources.list.d/*.list

# 3) Point at the archived Stretch repos (allowing for expired metadata)
- name: Configure Apt for the archived Stretch repositories
  raw: |
    cat > /etc/apt/apt.conf.d/99stretch-archive << 'EOF'
    Acquire {
      Check-Valid-Until "false";
      AllowInsecureRepositories "true";
      PDiffs "false";
    };
    EOF

    cat > /etc/apt/sources.list << 'EOF'
    deb http://archive.debian.org/debian stretch main
    deb http://archive.debian.org/debian-security stretch/updates main
    deb http://archive.debian.org/debian stretch-updates main
    deb http://archive.debian.org/debian stretch-backports main
    EOF
  changed_when: false

# 4) Fetch the new index, install just enough to get Python 3 & keyring
- name: Prime the keyring and install minimal Python & python-apt
  raw: |
    export DEBIAN_FRONTEND=noninteractive
    sleep 5
    apt-get update -o Acquire::Check-Valid-Until=false -o Acquire::AllowInsecureRepositories=true
    DEBIAN_FRONTEND=noninteractive apt-get install -y --allow-unauthenticated \
      --no-install-recommends \
      -o Dpkg::Options::="--force-confdef" \
      -o Dpkg::Options::="--force-confold" \
      debian-archive-keyring python3-minimal python3-apt
  changed_when: false

- name: Give the new python time to settle
  pause:
    seconds: 5

# 5) Tell Ansible which interpreter to use
- name: Locate python3 on the remote
  raw: which python3 || true
  register: _py3
  changed_when: false

- name: Set ansible_python_interpreter if found
  set_fact:
    ansible_python_interpreter: "{{ _py3.stdout | trim }}"
  when: _py3.stdout | trim != ""

- name: Fail if we still can’t find python3
  fail:
    msg: "python3 was not found on the remote after bootstrap!"
  when: _py3.stdout | trim == ""

# 6) Switch to the normal apt: module now that Python exists
- name: Install full python3.7, python3.7-venv, python3.7-apt and openssh-server
  apt:
    name:
      - python3.7
      - python3.7-venv
      - python3.7-apt
      - openssh-server
    state: latest
    update_cache: yes
    install_recommends: no
    default_release: stretch-backports

# 7) Generate an ED25519 keypair on the CONTROL node, once
- name: Ensure we have a root ed25519 keypair (control machine)
  delegate_to: localhost
  local_action:
    module: command
    cmd: ssh-keygen -t ed25519 -f "{{ playbook_dir }}/files/root_id_ed25519" -N ''
    creates: "{{ playbook_dir }}/files/root_id_ed25519"

# 8) Push the public half to the target’s authorized_keys
- name: Ensure /root/.ssh exists
  file:
    path: /root/.ssh
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Install root’s ed25519 public key
  authorized_key:
    user: root
    key: "{{ lookup('file', playbook_dir ~ '/files/root_id_ed25519.pub') }}"
    state: present
