global:
  file_watch_config:
    min_poll_frequency: 250ms
    max_poll_frequency: 250ms

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info
  enable_runtime_reload: true

clients:
  - url: {{ promtail_loki_url }}
    follow_redirects: true
    enable_http2: true
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    timeout: 10s

positions:
  filename: /var/lib/promtail/positions.yaml
  sync_period: 10s

limits_config:
  readline_rate: 10000
  readline_burst: 10000
  readline_rate_drop: true

scrape_configs:
  # ------------------------------------------------
  # A) SSH via systemd journal (preferred)
  # ------------------------------------------------
  - job_name: ssh-journal
    journal:
      path: /var/log/journal
      max_age: 24h
      labels:
        host: {{ promtail_host_label | quote }}
        app: sshd
        job: ssh-journal
    relabel_configs:
      # Only keep sshd / ssh.service entries
      - source_labels: ['__journal__systemd_unit']
        regex: 'ssh\.service|sshd\.service'
        action: keep

  # ------------------------------------------------
  # B) Fail2ban log file
  # ------------------------------------------------
  - job_name: fail2ban
    static_configs:
      - targets: [localhost]
        labels:
          host: {{ promtail_host_label | quote }}
          app: fail2ban
          job: fail2ban
          __path__: /var/log/fail2ban.log