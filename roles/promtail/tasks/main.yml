---
- name: Ensure promtail dirs exist
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /etc/promtail
    - /var/lib/promtail
  become: true

- name: Ensure curl and unzip are installed
  apt:
    name:
      - curl
      - unzip
    state: present
    update_cache: yes
    cache_valid_time: 3600
  become: true

- name: Check if promtail binary exists
  stat:
    path: /usr/local/bin/promtail
  register: promtail_bin

- name: Download and install promtail binary
  block:
    - name: Download promtail zip (via curl, avoid get_url bug)
      command: >
        curl -L --fail -o /tmp/promtail.zip "{{ promtail_download_url }}"
      args:
        creates: /tmp/promtail.zip

    - name: Unzip promtail
      unarchive:
        src: /tmp/promtail.zip
        dest: /usr/local/bin/
        remote_src: yes
        mode: "0755"
        owner: root
        group: root

    - name: Rename promtail binary to generic name
      command: mv /usr/local/bin/promtail-linux-arm64 /usr/local/bin/promtail
      args:
        creates: /usr/local/bin/promtail
      when: promtail_unzip is changed
      notify: restart promtail

    - name: Ensure promtail binary is executable
      file:
        path: /usr/local/bin/promtail
        mode: "0755"
        owner: root
        group: root
      notify: restart promtail

    - name: Remove downloaded promtail archive
      file:
        path: /tmp/promtail.zip
        state: absent
  when: not promtail_bin.stat.exists
  become: true

- name: Install promtail config for CloudKey
  template:
    src: config-cloudkey.yaml.j2
    dest: /etc/promtail/config-cloudkey.yaml
    owner: root
    group: root
    mode: "0644"
  notify: restart promtail
  become: true

- name: Install promtail systemd unit
  template:
    src: promtail.service.j2
    dest: /etc/systemd/system/promtail.service
    owner: root
    group: root
    mode: "0644"
  notify: restart promtail
  become: true

- name: Reload systemd and enable promtail
  systemd:
    name: promtail
    enabled: true
    state: started
    daemon_reload: true
  become: true
