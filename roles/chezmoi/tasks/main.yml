---
- name: Ensure sudo is available
  become: yes
  apt:
    name: sudo
    state: present

- name: Ensure home directory for {{ target_user }} exists and is writable
  become: yes
  file:
    path: "/home/{{ target_user }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0755"

- name: Ensure Ansible temp dir under home exists and is owned by {{ target_user }}
  become: yes
  file:
    path: "/home/{{ target_user }}/.ansible/tmp"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: "0700"

# Optional but safe: normalize everything under $HOME to the right owner
- name: Fix ownership inside {{ target_user }} home directory
  become: yes
  file:
    path: "/home/{{ target_user }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    recurse: yes

- name: Ensure chezmoi prerequisites are present
  become: yes
  apt:
    name:
      - curl
      - git
    state: present
    update_cache: yes

- name: Check if chezmoi repo is already initialized for {{ target_user }}
  become: yes
  become_user: "{{ target_user }}"
  stat:
    path: "/home/{{ target_user }}/.local/share/chezmoi"
  register: chezmoi_dir

# First-time init: install chezmoi (if needed) + apply dotfiles
- name: Initialize chezmoi for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
    # Make sure chezmoi in ~/.local/bin is on PATH
    PATH: "/home/{{ target_user }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
    # Let scripts detect they're running under automation if you ever need it
    ANSIBLE_RUN: "1"
  shell: |
    set -e
    # Install chezmoi locally for {{ target_user }} if missing
    if ! command -v chezmoi >/dev/null 2>&1; then
      sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
    fi

    # Initial clone + apply from your dotfiles repo
    chezmoi init --apply "https://github.com/{{ github_username }}/dotfiles.git"
  args:
    chdir: "/home/{{ target_user }}"
  when: not chezmoi_dir.stat.exists
  register: chezmoi_init
  retries: 5
  delay: 60
  until: chezmoi_init.rc == 0

# ⚠️ Intentionally NOT running `chezmoi update` automatically here.
# On subsequent runs, Ansible will skip the init step because the
# .local/share/chezmoi dir exists. You can run `chezmoi update`
# manually as {{ target_user }} once you're logged in.

# # Subsequent runs: just update/apply changes
# - name: Run chezmoi update for {{ target_user }} (with retries)
#   become: yes
#   become_user: "{{ target_user }}"
#   environment:
#     HOME: "/home/{{ target_user }}"
#     DEBIAN_FRONTEND: noninteractive
#     PATH: "/home/{{ target_user }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
#   shell: |
#     set -e
#     chezmoi update
#   args:
#     chdir: "/home/{{ target_user }}"
#   when: chezmoi_dir.stat.exists
#   register: chezmoi_update
#   retries: 5
#   delay: 60
#   until: chezmoi_update.rc == 0
