---
- name: Ensure sudo is available
  become: yes
  apt:
    name: sudo
    state: present

- name: Ensure chezmoi prerequisites are present
  become: yes
  apt:
    name:
      - curl
      - git
    state: present
    update_cache: yes

- name: Check if chezmoi repo is already initialized for {{ target_user }}
  become: yes
  become_user: "{{ target_user }}"
  stat:
    path: "/home/{{ target_user }}/.local/share/chezmoi"
  register: chezmoi_dir

# First-time init: install chezmoi (if needed) + apply dotfiles
- name: Initialize chezmoi for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
    # Make sure chezmoi in ~/.local/bin is on PATH
    PATH: "/home/{{ target_user }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
  shell: |
    set -e
    # Install chezmoi locally for {{ target_user }} if missing
    if ! command -v chezmoi >/dev/null 2>&1; then
      sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
    fi

    # Initial clone + apply from your dotfiles repo
    chezmoi init --apply "https://github.com/{{ github_username }}/dotfiles.git"
  args:
    chdir: "/home/{{ target_user }}"
  when: not chezmoi_dir.stat.exists
  register: chezmoi_init
  retries: 5
  delay: 60
  until: chezmoi_init.rc == 0

# Subsequent runs: just update/apply changes
- name: Run chezmoi update for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
    PATH: "/home/{{ target_user }}/.local/bin:/usr/local/bin:/usr/bin:/bin"
  shell: |
    set -e
    chezmoi update
  args:
    chdir: "/home/{{ target_user }}"
  when: chezmoi_dir.stat.exists
  register: chezmoi_update
  retries: 5
  delay: 60
  until: chezmoi_update.rc == 0
