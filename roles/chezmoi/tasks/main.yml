---
- name: Ensure sudo is available
  become: yes
  apt:
    name: sudo
    state: present
    update_cache: yes

- name: Ensure chezmoi prerequisites are present
  become: yes
  apt:
    name:
      - curl
      - git
    state: present

- name: Check if chezmoi repo is already initialized for {{ target_user }}
  become: yes
  become_user: "{{ target_user }}"
  stat:
    path: "/home/{{ target_user }}/.local/share/chezmoi"
  register: chezmoi_dir

# First-time init: installer script + apply
- name: Initialize chezmoi for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
  shell: |
    set -e
    # Use official installer to init + apply dotfiles
    sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply {{ github_username }} --verbose
  args:
    chdir: "/home/{{ target_user }}"
  when: not chezmoi_dir.stat.exists
  register: chezmoi_init
  retries: 5
  delay: 60
  until: chezmoi_init.rc == 0

# Subsequent runs: just update/apply changes
- name: Run chezmoi update for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
    # In case chezmoi is in ~/.local/bin after installer
    PATH: "/home/{{ target_user }}/.local/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"
  command: chezmoi update
  args:
    chdir: "/home/{{ target_user }}"
  when: chezmoi_dir.stat.exists
  register: chezmoi_update
  retries: 5
  delay: 60
  until: chezmoi_update.rc == 0
