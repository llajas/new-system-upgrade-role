---
- name: Ensure sudo is available
  become: yes
  apt:
    name: sudo
    state: present

- name: Ensure chezmoi prerequisites are present
  become: yes
  apt:
    name:
      - curl      # still handy for other stuff
      - git
      - chezmoi  # install from Debian once you're on 11/12/13
    state: present
    update_cache: yes

- name: Check if chezmoi repo is already initialized for {{ target_user }}
  become: yes
  become_user: "{{ target_user }}"
  stat:
    path: "/home/{{ target_user }}/.local/share/chezmoi"
  register: chezmoi_dir

# First-time init: clone + apply your dotfiles repo
- name: Initialize chezmoi for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
  command: >
    chezmoi init --apply
    "https://github.com/{{ github_username }}/dotfiles.git"
  args:
    chdir: "/home/{{ target_user }}"
  when: not chezmoi_dir.stat.exists
  register: chezmoi_init
  retries: 5
  delay: 60
  until: chezmoi_init.rc == 0

# Subsequent runs: just update/apply changes
- name: Run chezmoi update for {{ target_user }} (with retries)
  become: yes
  become_user: "{{ target_user }}"
  environment:
    HOME: "/home/{{ target_user }}"
    DEBIAN_FRONTEND: noninteractive
  command: chezmoi update
  args:
    chdir: "/home/{{ target_user }}"
  when: chezmoi_dir.stat.exists
  register: chezmoi_update
  retries: 5
  delay: 60
  until: chezmoi_update.rc == 0
